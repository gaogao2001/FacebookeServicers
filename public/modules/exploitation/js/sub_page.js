$(document).ready(function () {
    // Tải dữ liệu subpages
    function loadSubpages() {
        $.ajax({
            url: '/subpages',
            method: 'GET',
            success: function (data) {
                let rows = '';
                data.forEach(function (subpage) {
                    rows += `
                        <tr>
                            <td>${subpage.uid_sub}</td>
                            <td>${subpage.quantity}</td>
                            <td>${subpage.daily_run}</td>
                            <td>${subpage.delay}</td>
                            <td  class="truncate-message">${subpage.note}</td>
                            <td>${formatDate(subpage.last_run)}</td>
                            <td>${subpage.follow_start}</td>
                            <td>${subpage.follow_stop}</td>
                            <td>${subpage.today_run}</td>
                            <td>
                                <button class="btn btn-inverse-light edit-btn" 
                                        data-id="${subpage._id.$oid}" 
                                        data-toggle="modal" 
                                        data-target="#modal-CreareProxy">
                                    <i class="fa fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-inverse-danger delete-btn" 
                                  
                                        data-id="${subpage._id.$oid}">
                                    <i class="fa fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `;
                });
                $('#subpageList').html(rows);
            },
            error: function () {
                Swal.fire('Lỗi', 'Không thể tải dữ liệu.', 'error');
            }
        });
    }

    // Hàm định dạng ngày tháng
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;
        return date.toLocaleString();
    }

    loadSubpages();

    // Khi nhấn "Thêm cấu hình", reset modal và ẩn trường update-only
    $('#addConfigBtn').click(function () {
        $('#modalTitle').text('Thêm Cấu Hình');
        $('#editSubpageForm')[0].reset();
        $('#subId').val('');
        $('.update-only').hide();
    });

    // Khi nhấn "Edit", tải dữ liệu vào modal và hiện thị update-only fields
    $(document).on('click', '.edit-btn', function () {
        const id = $(this).data('id');
        $('#modalTitle').text('Chỉnh Sửa Cấu Hình');
        $('#editSubpageForm')[0].reset();
        $('#subId').val(id);
        $('.update-only').show();  // Hiển thị các trường chỉ chỉnh sửa

        $.ajax({
            url: `/subpages/${id}`,
            method: 'GET',
            success: function (subpage) {
                $('#uidSub').val(subpage.uid_sub);
                $('#quantity').val(subpage.quantity);
                $('#dailyRun').val(subpage.daily_run);
                $('#delay').val(subpage.delay);
                $('#note').val(subpage.note);
                // Gán giá trị nếu có, nếu không có gán rỗng
                $('#followStart').val(subpage.follow_start || '');
                $('#followStop').val(subpage.follow_stop || '');
                $('#todayRun').val(subpage.today_run || '');
            },
            error: function () {
                Swal.fire('Lỗi', 'Không thể lấy dữ liệu để chỉnh sửa.', 'error');
                $('#modal-CreareProxy').modal('hide');
            }
        });
    })

    // Lưu Subpage
    $('#saveSubpage').click(function () {
        const id = $('#subId').val().trim();
        // Chuẩn bị dữ liệu; nếu là thêm mới, bỏ qua các trường update-only
        const data = {
            uid_sub: $('#uidSub').val(),
            quantity: $('#quantity').val(),
            daily_run: $('#dailyRun').val(),
            delay: $('#delay').val(),
            note: $('#note').val()
        };

        if (id !== '') {
            data.last_run = $('#lastRun').val();
            data.follow_start = $('#followStart').val();
            data.follow_stop = $('#followStop').val();
            data.today_run = $('#todayRun').val();
        }

        if (id === '') {
            // Thêm mới
            $.ajax({
                url: '/subpages',
                method: 'POST',
                data: data,
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                success: function (response) {
                    Swal.fire('Thành công', response.message, 'success');
                    loadSubpages();

                    $('#modal-CreareProxy').modal('hide');
                },
                error: function () {
                    Swal.fire('Lỗi', 'Thêm mới thất bại.', 'error');
                }
            });
        } else {
            // Cập nhật
            $.ajax({
                url: `/subpages/${id}`,
                method: 'PUT',
                data: data,
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                success: function (response) {
                    Swal.fire('Thành công', response.message, 'success');
                    loadSubpages();

                    $('#modal-CreareProxy').modal('hide');
                },
                error: function () {
                    Swal.fire('Lỗi', 'Cập nhật thất bại.', 'error');
                }
            });
        }
    });

    // Xóa Subpage
    $(document).on('click', '.delete-btn', function () {
        const id = $(this).data('id');
        Swal.fire({
            title: 'Bạn có chắc chắn?',
            text: 'Bạn không thể hoàn nguyên hành động này!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Có, xóa nó!',
            cancelButtonText: 'Hủy bỏ'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/subpages/${id}`,
                    method: 'DELETE',
                    headers: {
                        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                    },
                    success: function () {
                        Swal.fire('Thành công', 'Xóa thành công.', 'success');
                        loadSubpages();
                    },
                    error: function () {
                        Swal.fire('Lỗi', 'Xóa thất bại.', 'error');
                    }
                });
            }
        });
    });
});