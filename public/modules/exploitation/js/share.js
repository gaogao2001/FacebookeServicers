$(document).ready(function () {
    // Tải dữ liệu shares
    function loadShares() {
        $.ajax({
            url: '/shares',
            method: 'GET',
            success: function (data) {
                let rows = '';
                data.forEach(function (share) {
                    rows += `
                        <tr>
                            <td>${share.uid_share}</td>
                            <td>${share.quantity}</td>
                            <td>${share.daily_run}</td>
                            <td>${share.delay}</td>
                            <td>${share.note}</td>
                            <td>${formatDate(share.last_run)}</td>
                            <td>${share.follow_start}</td>
                            <td>${share.follow_stop}</td>
                            <td>${share.today_run}</td>
                            <td>
                                <button class="btn btn-inverse-light edit-btn" 
                                        data-id="${share._id.$oid}" 
                                        data-toggle="modal" 
                                        data-target="#modal-CreareProxy">
                                    <i class="fa fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-inverse-danger delete-btn" 
                                        data-id="${share._id.$oid}">
                                    <i class="fa fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `;
                });
                $('#shareList').html(rows);
            },
            error: function () {
                Swal.fire('Lỗi', 'Không thể tải dữ liệu.', 'error');
            }
        });
    }

    // Hàm để định dạng ngày tháng
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString; // Nếu không phải là ngày hợp lệ, trả về bản gốc
        return date.toLocaleString();
    }

    loadShares();

    // Khi nhấn "Thêm cấu hình", reset modal
    $('#addConfigBtn').click(function () {
        $('#modalTitle').text('Thêm Cấu Hình Share');
        $('#editShareForm')[0].reset();
        $('#shareId').val(''); // Reset ID
    });

    // Khi nhấn "Edit", tải dữ liệu vào modal
    $(document).on('click', '.edit-btn', function () {
        const id = $(this).data('id');
        $('#modalTitle').text('Chỉnh Sửa Cấu Hình Share');
        $('#editShareForm')[0].reset();
        $('#shareId').val(id); // Set ID cho chế độ chỉnh sửa

        $.ajax({
            url: `/shares/${id}`,
            method: 'GET',
            success: function (share) {
                $('#uidShare').val(share.uid_share);
                $('#quantity').val(share.quantity);
                $('#dailyRun').val(share.daily_run);
                $('#delay').val(share.delay);
                $('#note').val(share.note);

                $('#lastRun').val(formatDate(share.last_run));
                $('#followStart').val(share.follow_start);
                $('#followStop').val(share.follow_stop);
                $('#todayRun').val(share.today_run);
            },
            error: function () {
                Swal.fire('Lỗi', 'Không thể lấy dữ liệu để chỉnh sửa.', 'error');
                $('#modal-CreareProxy').modal('hide');
            }
        });
    });

    // Lưu Share
    $('#saveSharepage').click(function () {
        const id = $('#shareId').val().trim();
        const data = {
            uid_share: $('#uidShare').val(),
            quantity: $('#quantity').val(),
            daily_run: $('#dailyRun').val(),
            delay: $('#delay').val(),
            note: $('#note').val(),

            last_run: $('#lastRun').val(),
            follow_start: $('#followStart').val(),
            follow_stop: $('#followStop').val(),
            today_run: $('#todayRun').val(),
        };

        if (id === '') {
            // Thêm mới
            $.ajax({
                url: '/shares',
                method: 'POST',
                data: data,
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                success: function () {
                    Swal.fire('Thành công', 'Thêm mới thành công.', 'success');
                    loadShares();
                    $('#editShareForm')[0].reset();
                    $('#modal-CreareProxy').modal('hide');
                },
                error: function (jqXHR) {
                    if (jqXHR.responseJSON && jqXHR.responseJSON.message) {
                        Swal.fire('Lỗi', jqXHR.responseJSON.message, 'error');
                    } else {
                        Swal.fire('Lỗi', 'Thêm mới thất bại.', 'error');
                    }
                }
            });
        } else {
            // Cập nhật
            $.ajax({
                url: `/shares/${id}`,
                method: 'PUT',
                data: data,
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                success: function () {
                    Swal.fire('Thành công', 'Cập nhật thành công.', 'success');
                    loadShares();
                    $('#editShareForm')[0].reset();
                    $('#modal-CreareProxy').modal('hide');
                },
                error: function (jqXHR) {
                    if (jqXHR.responseJSON && jqXHR.responseJSON.message) {
                        Swal.fire('Lỗi', jqXHR.responseJSON.message, 'error');
                    } else {
                        Swal.fire('Lỗi', 'Cập nhật thất bại.', 'error');
                    }
                }
            });
        }
    });

    // Xóa Share
    $(document).on('click', '.delete-btn', function () {
        const id = $(this).data('id');
        Swal.fire({
            title: 'Bạn có chắc chắn?',
            text: 'Bạn không thể hoàn nguyên hành động này!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Có, xóa nó!',
            cancelButtonText: 'Hủy bỏ'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/shares/${id}`,
                    method: 'DELETE',
                    headers: {
                        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                    },
                    success: function () {
                        Swal.fire('Thành công', 'Xóa thành công.', 'success');
                        loadShares();
                    },
                    error: function () {
                        Swal.fire('Lỗi', 'Xóa thất bại.', 'error');
                    }
                });
            }
        });
    });
});